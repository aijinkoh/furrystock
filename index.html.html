<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº“å­˜åŠ©æ‰‹ V5 - åˆ†ç±»å¯¼å‡ºç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; font-size: 14px; }
        .tab-content { display: none; padding: 12px; }
        .active-tab { display: block; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .item-row { background: #fff; padding: 12px; border-left: 5px solid #0d6efd; margin-bottom: 8px; position: relative; border-radius: 8px; }
        .sales-row { border-left-color: #198754; }
        .btn-remove { position: absolute; right: 5px; top: 5px; color: #dc3545; padding: 2px 8px; font-size: 16px; }
        .nav-fixed-bottom { position: fixed; bottom: 0; width: 100%; background: #fff; border-top: 1px solid #eee; display: flex; padding: 8px 0; z-index: 1001; }
        .nav-item { text-align: center; color: #888; text-decoration: none; flex: 1; font-size: 11px; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .history-card { border-radius: 10px; padding: 12px; margin-bottom: 10px; background: #fff; }
        .history-header { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 5px; margin-bottom: 8px; }
        .history-detail { font-size: 12px; color: #666; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand">åº“å­˜ V5</span>
        <div class="navbar-nav ms-auto">
            <div class="dropdown">
                <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">å¯¼å‡º</button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportType('purchase')">å¯¼å‡ºé‡‡è´­æ¸…å• (CSV)</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportType('sales')">å¯¼å‡ºé”€å”®æ¸…å• (CSV)</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="exportType('all')">å¯¼å‡ºå…¨é‡å¤‡ä»½ (ç”¨äºå¯¼å…¥)</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-warning btn-sm ms-2" onclick="document.getElementById('importFile').click()">å¯¼å…¥</button>
            <input type="file" id="importFile" accept=".csv" onchange="importData(this)" style="display:none">
        </div>
    </div>
</nav>

<!-- 1. é‡‡è´­å½•å…¥ -->
<div id="purchase" class="tab-content active-tab">
    <div class="card p-3">
        <label class="form-label fw-bold">é‡‡è´­æ—¥æœŸ</label>
        <input type="date" class="form-control mb-3" id="pDate">
        <div id="pItemsContainer"></div>
        <button class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addPurchaseRow()">+ æ·»åŠ è´§å“</button>
        <button class="btn btn-primary w-100 py-2" onclick="savePurchase()">ä¿å­˜æ•´ç¬”é‡‡è´­</button>
    </div>
</div>

<!-- 2. é”€å”®å½•å…¥ -->
<div id="sales" class="tab-content">
    <div class="card p-3">
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="form-label fw-bold">æ—¥æœŸ</label><input type="date" class="form-control" id="sDate"></div>
            <div class="col-6"><label class="form-label fw-bold">è®¢å• ID</label><input type="text" class="form-control" id="sOrderId" placeholder="é€‰å¡«"></div>
        </div>
        <div id="sItemsContainer"></div>
        <button class="btn btn-outline-success btn-sm w-100 mb-3" onclick="addSalesRow()">+ æ·»åŠ è´§å“</button>
        <div class="row g-2 mb-3 pt-2 border-top">
            <div class="col-6"><label class="form-label">æ€»ä¼˜æƒ </label><input type="number" step="0.01" class="form-control" id="sTotalCoupon" value="0"></div>
            <div class="col-6"><label class="form-label">æ‰‹ç»­è´¹</label><input type="number" step="0.01" class="form-control" id="sTotalFee" value="0"></div>
        </div>
        <button class="btn btn-success w-100 py-2" onclick="saveSales()">ç¡®è®¤ç»“å•</button>
    </div>
</div>

<!-- 3. å†å²è®°å½• -->
<div id="history" class="tab-content">
    <div class="btn-group w-100 mb-3 shadow-sm">
        <input type="radio" class="btn-check" name="histType" id="histP" checked onchange="renderHistory()">
        <label class="btn btn-outline-primary" for="histP">é‡‡è´­è®°å½•</label>
        <input type="radio" class="btn-check" name="histType" id="histS" onchange="renderHistory()">
        <label class="btn btn-outline-success" for="histS">é”€å”®å†å²</label>
    </div>
    <div id="historyList"></div>
</div>

<!-- 4. å®æ—¶åº“å­˜ -->
<div id="inventory" class="tab-content">
    <div class="row g-2 mb-3">
        <div class="col-6"><select class="form-select" id="filterYear" onchange="renderInventory()"></select></div>
        <div class="col-6"><select class="form-select" id="filterMonth" onchange="renderInventory()"></select></div>
    </div>
    <div class="table-responsive bg-white rounded shadow-sm">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-light"><tr><th>åç§°</th><th class="text-center">åˆ</th><th class="text-center">è¿›</th><th class="text-center">é”€</th><th class="text-center">ä½™</th></tr></thead>
            <tbody id="inventoryTable"></tbody>
        </table>
    </div>
</div>

<div class="nav-fixed-bottom">
    <a href="javascript:void(0)" class="nav-item active" onclick="showTab('purchase', this)"><span class="nav-icon">ğŸ“¦</span>è¿›è´§</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('sales', this)"><span class="nav-icon">ğŸ’°</span>å‡ºè´§</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('history', this)"><span class="nav-icon">ğŸ“œ</span>è®°å½•</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('inventory', this)"><span class="nav-icon">ğŸ“Š</span>åº“å­˜</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const products = ["Keychain RM1", "Keychain RM2", "Keychain RM3", "Plush RM1", "Plush RM2", "Plush RM3", "Plush RM5", "Plush RM10", "Plush RM15", "Plush RM20", "Figurine & Toy RM3", "Figurine & Toy RM6", "Figurine & Toy RM10", "Figurine & Toy RM15", "Stationary RM0.6", "Stationary RM1", "Stationary RM2", "Stationary RM3", "Handkechief RM1", "Handkechief RM2", "Handkechief RM3", "Bag RM1", "Bag RM2", "Bag RM3", "Bag RM6", "Others RM3", "Others RM6"];

let purchases = JSON.parse(localStorage.getItem('v5_purchases')) || [];
let sales = JSON.parse(localStorage.getItem('v5_sales')) || [];
let initialStock = JSON.parse(localStorage.getItem('v5_initialStock')) || {};

function showTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active-tab');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    if(id === 'inventory') renderInventory();
    if(id === 'history') renderHistory();
}

// --- åŠ¨æ€è¡Œ ---
function addPurchaseRow() {
    const id = Date.now() + Math.random();
    document.getElementById('pItemsContainer').insertAdjacentHTML('beforeend', `<div class="item-row card" id="pRow_${id}">
        <button class="btn btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        <select class="form-select form-select-sm mb-2 p-item">${products.map(p => `<option value="${p}">${p}</option>`).join('')}</select>
        <div class="row g-2">
            <div class="col-4"><input type="number" step="0.01" class="form-control form-control-sm p-price" placeholder="ä»·"></div>
            <div class="col-4"><input type="number" class="form-control form-control-sm p-qty" placeholder="é‡"></div>
            <div class="col-4 d-flex align-items-center small"><input type="checkbox" class="p-bag me-1">+0.2</div>
        </div>
    </div>`);
}

function addSalesRow() {
    const id = Date.now() + Math.random();
    document.getElementById('sItemsContainer').insertAdjacentHTML('beforeend', `<div class="item-row sales-row card" id="sRow_${id}">
        <button class="btn btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        <select class="form-select form-select-sm mb-2 s-item">${products.map(p => `<option value="${p}">${p}</option>`).join('')}</select>
        <div class="row g-2">
            <div class="col-6"><input type="number" step="0.01" class="form-control form-control-sm s-price" placeholder="é‡‘é¢"></div>
            <div class="col-6"><input type="number" class="form-control form-control-sm s-qty" placeholder="æ•°é‡"></div>
        </div>
    </div>`);
}

// --- ä¿å­˜ ---
function savePurchase() {
    const date = document.getElementById('pDate').value, batchId = Date.now(), rows = document.querySelectorAll('#pItemsContainer .item-row');
    if(!date || rows.length === 0) return alert('æ—¥æœŸæˆ–å•†å“ä¸èƒ½ä¸ºç©º');
    rows.forEach(row => {
        const item = row.querySelector('.p-item').value, price = parseFloat(row.querySelector('.p-price').value) || 0, qty = parseInt(row.querySelector('.p-qty').value) || 0, bag = row.querySelector('.p-bag').checked;
        if(qty > 0) purchases.push({ batchId, date, item, qty, price: bag?price+0.2:price, cost: ((bag?price+0.2:price)*qty).toFixed(2) });
    });
    localStorage.setItem('v5_purchases', JSON.stringify(purchases));
    document.getElementById('pItemsContainer').innerHTML = ''; alert('é‡‡è´­è®°å½•å·²å­˜');
}

function saveSales() {
    const date = document.getElementById('sDate').value, orderId = document.getElementById('sOrderId').value || 'ID-'+Date.now(), batchId = Date.now(), coupon = parseFloat(document.getElementById('sTotalCoupon').value) || 0, fee = parseFloat(document.getElementById('sTotalFee').value) || 0;
    const rows = document.querySelectorAll('#sItemsContainer .item-row');
    if(!date || rows.length === 0) return alert('æ•°æ®ä¸èƒ½ä¸ºç©º');
    rows.forEach(row => {
        const item = row.querySelector('.s-item').value, amount = parseFloat(row.querySelector('.s-price').value) || 0, qty = parseInt(row.querySelector('.s-qty').value) || 0;
        if(qty > 0) sales.push({ batchId, date, orderId, item, qty, amount, coupon, fee });
    });
    localStorage.setItem('v5_sales', JSON.stringify(sales));
    document.getElementById('sItemsContainer').innerHTML = ''; alert('é”€å”®è®¢å•å·²å½•å…¥');
}

// --- å†å²ä¸åº“å­˜ ---
function renderHistory() {
    const list = document.getElementById('historyList'), isP = document.getElementById('histP').checked, data = isP ? purchases : sales, groups = {};
    list.innerHTML = '';
    data.forEach(d => { if(!groups[d.batchId]) groups[d.batchId] = []; groups[d.batchId].push(d); });
    Object.keys(groups).sort((a,b) => b-a).forEach(id => {
        const items = groups[id], first = items[0];
        let subTotal = items.reduce((s, i) => s + parseFloat(isP ? i.cost : i.amount), 0);
        let final = isP ? subTotal : (subTotal - first.coupon - first.fee);
        list.innerHTML += `<div class="history-card shadow-sm border-start border-4 ${isP?'border-primary':'border-success'}">
            <div class="history-header"><span class="fw-bold">${first.date}</span><span class="badge ${isP?'bg-primary':'bg-success'}">RM ${final.toFixed(2)}</span></div>
            <div class="history-detail mb-2">
                ${!isP ? `å•å·: ${first.orderId}<br>` : ''}
                ${items.map(i => `Â· ${i.item} x ${i.qty} (RM${isP?i.cost:i.amount})`).join('<br>')}
                ${!isP && (first.coupon>0||first.fee>0) ? `<div class="text-danger border-top mt-1 pt-1">ä¼˜æƒ :-${first.coupon} | æ‰‹ç»­è´¹:-${first.fee}</div>` : ''}
            </div>
            <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteBatch('${id}', ${isP})">åˆ é™¤æ­¤è®°å½•</button>
        </div>`;
    });
}

function deleteBatch(id, isP) {
    if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
    if(isP) { purchases = purchases.filter(p => p.batchId != id); localStorage.setItem('v5_purchases', JSON.stringify(purchases)); }
    else { sales = sales.filter(s => s.batchId != id); localStorage.setItem('v5_sales', JSON.stringify(sales)); }
    renderHistory();
}

function renderInventory() {
    const y = document.getElementById('filterYear').value, m = document.getElementById('filterMonth').value, tbody = document.getElementById('inventoryTable');
    tbody.innerHTML = '';
    products.forEach(name => {
        const tin = purchases.filter(p => { const d = new Date(p.date); return p.item === name && d.getFullYear() == y && (m === 'all' || d.getMonth() == m); }).reduce((s, p) => s + p.qty, 0);
        const tout = sales.filter(s => { const d = new Date(s.date); return s.item === name && d.getFullYear() == y && (m === 'all' || d.getMonth() == m); }).reduce((s, s1) => s + s1.qty, 0);
        const init = initialStock[name] || 0;
        tbody.innerHTML += `<tr><td style="font-size:11px">${name}</td><td class="text-center text-primary" onclick="editInitial('${name}')">${init}</td><td class="text-center text-success">${tin}</td><td class="text-center text-danger">${tout}</td><td class="text-center fw-bold">${init+tin-tout}</td></tr>`;
    });
}

function editInitial(name) {
    const val = prompt(`åˆå§‹åº“å­˜ ${name}:`, initialStock[name] || 0);
    if(val !== null) { initialStock[name] = parseInt(val) || 0; localStorage.setItem('v5_initialStock', JSON.stringify(initialStock)); renderInventory(); }
}

// --- å¢å¼ºå¯¼å‡ºé€»è¾‘ ---
function exportType(type) {
    let csv = "\uFEFF";
    let filename = "";

    if (type === 'purchase') {
        filename = `é‡‡è´­æ¸…å•_${new Date().toLocaleDateString()}.csv`;
        csv += "æ—¥æœŸ,è´§å“åç§°,å•ä»·(å«çº¸è¢‹),é‡‡è´­æ•°é‡,æ€»è´¹ç”¨\n";
        purchases.forEach(p => {
            csv += `${p.date},${p.item},${p.price},${p.qty},${p.cost}\n`;
        });
    } else if (type === 'sales') {
        filename = `é”€å”®æ¸…å•_${new Date().toLocaleDateString()}.csv`;
        csv += "æ—¥æœŸ,è®¢å•ID,è´§å“åç§°,æ•°é‡,åŸä»·é‡‘é¢,è®¢å•æ€»ä¼˜æƒ ,è®¢å•æ‰‹ç»­è´¹,åˆ°æ‰‹æœ€ç»ˆé‡‘é¢(æ•´å•)\n";
        sales.forEach(s => {
            const final = (s.amount - s.coupon - s.fee).toFixed(2);
            csv += `${s.date},${s.orderId},${s.item},${s.qty},${s.amount},${s.coupon},${s.fee},${final}\n`;
        });
    } else if (type === 'all') {
        // ä¿æŒåŸæœ‰çš„å…¨é‡å¤‡ä»½æ ¼å¼ï¼Œä»¥ä¾¿å¯¼å…¥
        filename = `å…¨é‡å¤‡ä»½_V5_${new Date().toISOString().slice(0,10)}.csv`;
        csv += "SECTION,DATA1,DATA2,DATA3,DATA4,DATA5,DATA6,DATA7,BATCHID\n";
        Object.keys(initialStock).forEach(k => csv += `INIT,${k},${initialStock[k]},,,,,,,\n`);
        purchases.forEach(p => csv += `PURCHASE,${p.date},${p.item},${p.qty},${p.price},${p.cost},,,,${p.batchId}\n`);
        sales.forEach(s => csv += `SALE,${s.date},${s.orderId},${s.item},${s.qty},${s.amount},${s.coupon},${s.fee},${s.batchId}\n`);
    }

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

function importData(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split('\n'); if(!confirm("æ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰è®°å½•ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        purchases = []; sales = []; initialStock = {};
        lines.forEach((line, index) => {
            if(index === 0 || !line.trim()) return;
            const c = line.split(','); const type = c[0];
            if(type === 'INIT') initialStock[c[1]] = parseInt(c[2]);
            if(type === 'PURCHASE') purchases.push({date:c[1], item:c[2], qty:parseInt(c[3]), price:parseFloat(c[4]), cost:c[5], batchId:c[9]||Date.now()});
            if(type === 'SALE') sales.push({date:c[1], orderId:c[2], item:c[3], qty:parseInt(c[4]), amount:parseFloat(c[5]), coupon:parseFloat(c[6]), fee:parseFloat(c[7]), batchId:c[8]||Date.now()});
        });
        localStorage.setItem('v5_purchases', JSON.stringify(purchases));
        localStorage.setItem('v5_sales', JSON.stringify(sales));
        localStorage.setItem('v5_initialStock', JSON.stringify(initialStock));
        location.reload();
    };
    reader.readAsText(file);
}

window.onload = function() {
    document.getElementById('pDate').valueAsDate = new Date();
    document.getElementById('sDate').valueAsDate = new Date();
    const ySel = document.getElementById('filterYear'), curY = new Date().getFullYear();
    for(let y=curY; y>=curY-2; y--) ySel.options.add(new Option(y+"å¹´", y));
    const mSel = document.getElementById('filterMonth');
    mSel.options.add(new Option("å…¨å¹´å®æ—¶", "all"));
    for(let m=0; m<12; m++) mSel.options.add(new Option((m+1)+"æœˆ", m));
    addPurchaseRow(); addSalesRow();
};
</script>
</body>
</html>