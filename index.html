<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>åº“å­˜ç®¡å®¶ V11 - ç²¾ç¡®æ ¸ç®—ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --safe-area-inset-bottom: env(safe-area-inset-bottom); }
        body { background-color: #f0f2f5; padding-bottom: calc(80px + var(--safe-area-inset-bottom)); font-size: 14px; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; padding: 12px; }
        .active-tab { display: block; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .item-row { background: #fff; padding: 12px; border-left: 5px solid #0d6efd; margin-bottom: 8px; position: relative; border-radius: 8px; }
        .sales-row { border-left-color: #198754; }
        .btn-remove { position: absolute; right: 5px; top: 0px; color: #dc3545; padding: 5px; font-size: 18px; border:none; background:none; z-index: 10; }
        .nav-fixed-bottom { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #eee; display: flex; padding: 10px 0 calc(10px + var(--safe-area-inset-bottom)); z-index: 1001; }
        .nav-item { text-align: center; color: #888; text-decoration: none; flex: 1; font-size: 11px; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .month-group { margin-bottom: 10px; border-radius: 10px; overflow: hidden; border: 1px solid #dee2e6; background: #fff; }
        .month-header { padding: 12px 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .month-header:after { content: 'â–¼'; font-size: 10px; color: #999; }
        .month-group.active .month-content { display: block; }
        .month-group.active .month-header:after { content: 'â–²'; }
        .month-content { display: none; padding: 10px; background: #fdfdfd; }
        .history-card { border-radius: 8px; padding: 10px; margin-bottom: 8px; background: #fff; border: 1px solid #eee; border-left: 4px solid #ddd; }
        th { font-weight: 600; color: #666; background-color: #f8f9fa !important; font-size: 11px; text-align: center; }
        .small-label { font-size: 11px; color: #666; margin-bottom: 2px; display: block; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand">åº“å­˜ç®¡å®¶ V11</span>
        <div class="navbar-nav ms-auto">
            <div class="dropdown">
                <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">å¯¼å‡º</button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportType('purchase')">å¯¼å‡ºé‡‡è´­æ¸…å•</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportType('sales')">å¯¼å‡ºé”€å”®æ¸…å•</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="exportType('all')">å…¨é‡æ•°æ®å¤‡ä»½</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-warning btn-sm ms-2" onclick="document.getElementById('importFile').click()">å¯¼å…¥</button>
            <input type="file" id="importFile" accept=".csv" onchange="importData(this)" style="display:none">
        </div>
    </div>
</nav>

<!-- è¿›è´§å½•å…¥ -->
<div id="purchase" class="tab-content active-tab">
    <div class="card p-3 shadow-sm">
        <label class="form-label fw-bold small">é‡‡è´­æ—¥æœŸ</label>
        <input type="date" class="form-control mb-3" id="pDate">
        <div id="pItemsContainer"></div>
        <button class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addPurchaseRow()">+ æ·»åŠ è´§å“</button>
        <div class="p-2 bg-light rounded text-center mb-3">
            <label class="small-label fw-bold">æœ¬æ¬¡é‡‡è´­çº¸è¢‹æ•°é‡ (RM0.2/ä¸ª)</label>
            <input type="number" class="form-control form-control-sm mx-auto text-center" id="pBagCount" value="0" style="max-width: 100px;">
        </div>
        <button class="btn btn-primary w-100 py-2" onclick="savePurchase()">ä¿å­˜æ•´ç¬”é‡‡è´­</button>
    </div>
</div>

<!-- å‡ºè´§å½•å…¥ -->
<div id="sales" class="tab-content">
    <div class="card p-3 shadow-sm">
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="form-label fw-bold small">é”€å”®æ—¥æœŸ</label><input type="date" class="form-control" id="sDate"></div>
            <div class="col-6"><label class="form-label fw-bold small">è®¢å• ID</label><input type="text" class="form-control" id="sOrderId" placeholder="é€‰å¡«"></div>
        </div>
        <div id="sItemsContainer"></div>
        <button class="btn btn-outline-success btn-sm w-100 mb-3" onclick="addSalesRow()">+ æ·»åŠ è´§å“</button>
        <div class="row g-2 mb-2 pt-2 border-top">
            <div class="col-6"><label class="small-label">æ•´å•ä¼˜æƒ  (-)</label><input type="number" step="0.01" class="form-control" id="sTotalCoupon" value="0"></div>
            <div class="col-6"><label class="small-label">æ‰‹ç»­è´¹/è¿è´¹ (-)</label><input type="number" step="0.01" class="form-control" id="sTotalFee" value="0"></div>
        </div>
        <div class="mb-3">
            <label class="small-label text-success fw-bold">å¹³å°é‡‘é¢è°ƒæ•´ / è¡¥å·®ä»· (+)</label>
            <input type="number" step="0.01" class="form-control border-success" id="sAdjustment" value="0">
        </div>
        <button class="btn btn-success w-100 py-2" onclick="saveSales()">ç¡®è®¤ç»“å•</button>
    </div>
</div>

<!-- å†å²è®°å½• -->
<div id="history" class="tab-content">
    <div class="btn-group w-100 mb-3 shadow-sm">
        <input type="radio" class="btn-check" name="histType" id="histP" checked onchange="renderHistory()">
        <label class="btn btn-outline-primary" for="histP">è¿›è´§å†å²</label>
        <input type="radio" class="btn-check" name="histType" id="histS" onchange="renderHistory()">
        <label class="btn btn-outline-success" for="histS">é”€å”®å†å²</label>
    </div>
    <div id="historyList"></div>
</div>

<!-- å®æ—¶åº“å­˜ -->
<div id="inventory" class="tab-content">
    <div class="row g-2 mb-3">
        <div class="col-6"><select class="form-select" id="filterYear" onchange="renderInventory()"></select></div>
        <div class="col-6"><select class="form-select" id="filterMonth" onchange="renderInventory()"></select></div>
    </div>
    <div class="table-responsive bg-white shadow-sm rounded">
        <table class="table table-sm table-hover mb-0" style="min-width: 420px;">
            <thead class="table-light text-nowrap"><tr><th style="text-align:left;">è´§å“åç§°</th><th>ä¸ŠæœŸä½™</th><th>è¿›</th><th>é”€</th><th>å½“å‰ä½™</th></tr></thead>
            <tbody id="inventoryTable"></tbody>
        </table>
    </div>
</div>

<div class="nav-fixed-bottom">
    <a href="javascript:void(0)" class="nav-item active" onclick="showTab('purchase', this)"><span class="nav-icon">ğŸ“¦</span>è¿›è´§</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('sales', this)"><span class="nav-icon">ğŸ’°</span>å‡ºè´§</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('history', this)"><span class="nav-icon">ğŸ“œ</span>è®°å½•</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('inventory', this)"><span class="nav-icon">ğŸ“Š</span>åº“å­˜</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const products = ["Keychain RM1", "Keychain RM2", "Keychain RM3", "Plush RM1", "Plush RM2", "Plush RM3", "Plush RM5", "Plush RM10", "Plush RM15", "Plush RM20", "Figurine & Toy RM3", "Figurine & Toy RM6", "Figurine & Toy RM10", "Figurine & Toy RM15", "Stationary RM0.6", "Stationary RM1", "Stationary RM2", "Stationary RM3", "Handkechief RM1", "Handkechief RM2", "Handkechief RM3", "Bag RM1", "Bag RM2", "Bag RM3", "Bag RM6", "Others RM3", "Others RM6"];

let purchases = JSON.parse(localStorage.getItem('v5_purchases')) || [];
let sales = JSON.parse(localStorage.getItem('v5_sales')) || [];
let initialStock = JSON.parse(localStorage.getItem('v5_initialStock')) || {};

function extractPrice(name) {
    const match = name.match(/RM([\d.]+)/);
    return match ? parseFloat(match[1]) : 0;
}

function showTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active-tab');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    if(id === 'inventory') renderInventory();
    if(id === 'history') renderHistory();
}

// --- è¿›è´§ ---
function addPurchaseRow() {
    const id = Date.now() + Math.random();
    const defaultProduct = products[0], defaultPrice = extractPrice(defaultProduct);
    document.getElementById('pItemsContainer').insertAdjacentHTML('beforeend', `
        <div class="item-row card" id="pRow_${id}">
            <button class="btn btn-remove" onclick="this.parentElement.remove()">âœ•</button>
            <select class="form-select form-select-sm mb-2 p-item" onchange="this.parentElement.querySelector('.p-price').value = extractPrice(this.value)">
                ${products.map(p => `<option value="${p}">${p}</option>`).join('')}
            </select>
            <div class="row g-2">
                <div class="col-6"><div class="input-group input-group-sm"><span class="input-group-text">RM</span><input type="number" step="0.01" class="form-control p-price" value="${defaultPrice}"></div></div>
                <div class="col-6"><input type="number" class="form-control form-control-sm p-qty" placeholder="æ•°é‡"></div>
            </div>
        </div>`);
}

function savePurchase() {
    const date = document.getElementById('pDate').value, batchId = Date.now(), rows = document.querySelectorAll('#pItemsContainer .item-row');
    const bagQty = parseInt(document.getElementById('pBagCount').value) || 0;
    
    if(!date || rows.length === 0) return alert('è¯·æ£€æŸ¥æ•°æ®');
    
    rows.forEach((row, index) => {
        const item = row.querySelector('.p-item').value, price = parseFloat(row.querySelector('.p-price').value) || 0, qty = parseInt(row.querySelector('.p-qty').value) || 0;
        // çº¸è¢‹è´¹ç”¨å¹³æ‘Šåˆ°ç¬¬ä¸€é¡¹ï¼ˆä»…ç”¨äºè®°å½•ï¼‰
        const bagCost = (index === 0) ? (bagQty * 0.2) : 0;
        if(qty > 0) purchases.push({ batchId, date, item, qty, price, cost: (price * qty + bagCost).toFixed(2), bagQty: index === 0 ? bagQty : 0 });
    });
    localStorage.setItem('v5_purchases', JSON.stringify(purchases));
    document.getElementById('pItemsContainer').innerHTML = ''; document.getElementById('pBagCount').value = 0; alert('é‡‡è´­å·²å­˜å…¥');
}

// --- å‡ºè´§ ---
function addSalesRow() {
    const id = Date.now() + Math.random();
    const defaultProduct = products[0], defaultPrice = extractPrice(defaultProduct);
    document.getElementById('sItemsContainer').insertAdjacentHTML('beforeend', `
        <div class="item-row sales-row card" id="sRow_${id}">
            <button class="btn btn-remove" onclick="this.parentElement.remove()">âœ•</button>
            <select class="form-select form-select-sm mb-2 s-item" onchange="this.parentElement.querySelector('.s-price').value = extractPrice(this.value)">
                ${products.map(p => `<option value="${p}">${p}</option>`).join('')}
            </select>
            <div class="row g-2">
                <div class="col-6"><div class="input-group input-group-sm"><span class="input-group-text">RM</span><input type="number" step="0.01" class="form-control s-price" value="${defaultPrice}"></div></div>
                <div class="col-6"><input type="number" class="form-control form-control-sm s-qty" placeholder="æ•°é‡"></div>
            </div>
        </div>`);
}

function saveSales() {
    const date = document.getElementById('sDate').value, orderId = document.getElementById('sOrderId').value || 'ID-'+Date.now(), batchId = Date.now();
    const coupon = parseFloat(document.getElementById('sTotalCoupon').value) || 0;
    const fee = parseFloat(document.getElementById('sTotalFee').value) || 0;
    const adjust = parseFloat(document.getElementById('sAdjustment').value) || 0;
    const rows = document.querySelectorAll('#sItemsContainer .item-row');
    
    if(!date || rows.length === 0) return alert('æ•°æ®ä¸èƒ½ä¸ºç©º');
    rows.forEach(row => {
        const item = row.querySelector('.s-item').value, price = parseFloat(row.querySelector('.s-price').value) || 0, qty = parseInt(row.querySelector('.s-qty').value) || 0;
        if(qty > 0) sales.push({ batchId, date, orderId, item, qty, unitAmount: price, amount: (price * qty).toFixed(2), coupon, fee, adjust });
    });
    localStorage.setItem('v5_sales', JSON.stringify(sales));
    document.getElementById('sItemsContainer').innerHTML = ''; 
    document.getElementById('sTotalCoupon').value = 0; document.getElementById('sTotalFee').value = 0; document.getElementById('sAdjustment').value = 0;
    alert('é”€å”®è®¢å•å·²å…¥è´¦');
}

// --- å†å² ---
function renderHistory() {
    const list = document.getElementById('historyList'), isP = document.getElementById('histP').checked, data = isP ? purchases : sales;
    list.innerHTML = '';
    const monthGroups = {};
    data.forEach(item => {
        const d = new Date(item.date), mKey = `${d.getFullYear()}å¹´ ${d.getMonth() + 1}æœˆ`;
        if(!monthGroups[mKey]) monthGroups[mKey] = {};
        if(!monthGroups[mKey][item.batchId]) monthGroups[mKey][item.batchId] = [];
        monthGroups[mKey][item.batchId].push(item);
    });

    Object.keys(monthGroups).sort((a,b) => {
        const parse = (s) => { const [y, m] = s.replace('å¹´','').replace('æœˆ','').split(' '); return parseInt(y)*12 + parseInt(m); };
        return parse(b) - parse(a);
    }).forEach(mKey => {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'month-group';
        monthDiv.innerHTML = `<div class="month-header" onclick="this.parentElement.classList.toggle('active')">${mKey}</div><div class="month-content"></div>`;
        const contentDiv = monthDiv.querySelector('.month-content');
        const batches = monthGroups[mKey];
        Object.keys(batches).sort((a,b) => b-a).forEach(bId => {
            const items = batches[bId], first = items[0];
            let sub = items.reduce((s, i) => s + parseFloat(isP ? i.cost : i.amount), 0);
            let final = isP ? sub : (sub - first.coupon - first.fee + first.adjust);
            contentDiv.innerHTML += `
                <div class="history-card ${isP?'border-primary':'border-success'} shadow-sm">
                    <div class="d-flex justify-content-between small fw-bold border-bottom mb-2 pb-1">
                        <span>${first.date}</span><span class="${isP?'text-primary':'text-success'}">RM ${final.toFixed(2)}</span>
                    </div>
                    <div class="small text-muted mb-2">
                        ${!isP ? `å•å·: ${first.orderId}<br>` : ''}
                        ${items.map(i => `Â· ${i.item} x ${i.qty} (RM${isP?i.cost:i.amount})`).join('<br>')}
                        ${isP && first.bagQty > 0 ? `<div class="text-primary mt-1 small">çº¸è¢‹æ•°é‡: ${first.bagQty} (RM ${(first.bagQty*0.2).toFixed(2)})</div>` : ''}
                        ${!isP && (first.coupon>0||first.fee>0||first.adjust!=0) ? `<div class="text-danger mt-1 small">ä¼˜æƒ :-${first.coupon} | è´¹:-${first.fee} | è°ƒæ•´:+${first.adjust}</div>` : ''}
                    </div>
                    <button class="btn btn-sm btn-link text-danger p-0" style="font-size:11px" onclick="deleteBatch('${bId}', ${isP})">åˆ é™¤è®°å½•</button>
                </div>`;
        });
        list.appendChild(monthDiv);
    });
}

function deleteBatch(id, isP) {
    if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
    if(isP) purchases = purchases.filter(p => p.batchId != id);
    else sales = sales.filter(s => s.batchId != id);
    localStorage.setItem(isP ? 'v5_purchases' : 'v5_sales', JSON.stringify(isP ? purchases : sales));
    renderHistory();
}

// --- åº“å­˜ ---
function renderInventory() {
    const y = parseInt(document.getElementById('filterYear').value), m = document.getElementById('filterMonth').value, tbody = document.getElementById('inventoryTable');
    tbody.innerHTML = '';
    const start = new Date(y, m === 'all' ? 0 : parseInt(m), 1);
    const end = m === 'all' ? new Date(y + 1, 0, 1) : new Date(y, parseInt(m) + 1, 1);
    products.forEach(name => {
        const hIn = purchases.filter(p => p.item === name && new Date(p.date) < start).reduce((s, p) => s + p.qty, 0);
        const hOut = sales.filter(s => s.item === name && new Date(s.date) < start).reduce((s, s1) => s + s1.qty, 0);
        const open = (initialStock[name] || 0) + hIn - hOut;
        const cIn = purchases.filter(p => { const d = new Date(p.date); return p.item === name && d >= start && d < end; }).reduce((s, p) => s + p.qty, 0);
        const cOut = sales.filter(s => { const d = new Date(s.date); return s.item === name && d >= start && d < end; }).reduce((s, s1) => s + s1.qty, 0);
        tbody.innerHTML += `<tr><td style="font-size:11px;">${name}</td><td class="text-center text-secondary">${open}</td><td class="text-center text-success">${cIn}</td><td class="text-center text-danger">${cOut}</td><td class="text-center fw-bold text-primary" onclick="editInitial('${name}')">${open + cIn - cOut}</td></tr>`;
    });
}

function editInitial(name) {
    const val = prompt(`è®¾ç½® ${name} åŸå§‹åˆå§‹ç»“ä½™:`, initialStock[name] || 0);
    if(val !== null) { initialStock[name] = parseInt(val) || 0; localStorage.setItem('v5_initialStock', JSON.stringify(initialStock)); renderInventory(); }
}

// --- å¤‡ä»½ ---
function exportType(type) {
    let csv = "\uFEFF";
    if (type === 'purchase') {
        csv += "æ—¥æœŸ,è´§å“,å•ä»·,æ•°é‡,æ€»è®¡,çº¸è¢‹æ•°\n";
        purchases.forEach(p => csv += `${p.date},${p.item},${p.price},${p.qty},${p.cost},${p.bagQty}\n`);
    } else if (type === 'sales') {
        csv += "æ—¥æœŸ,å•å·,è´§å“,æ•°é‡,å•ä»·,å°è®¡,ä¼˜æƒ ,æ‰‹ç»­è´¹,å¹³å°è°ƒæ•´\n";
        sales.forEach(s => csv += `${s.date},${s.orderId},${s.item},${s.qty},${s.unitAmount},${s.amount},${s.coupon},${s.fee},${s.adjust}\n`);
    } else {
        csv += "SECTION,DATA1,DATA2,DATA3,DATA4,DATA5,DATA6,DATA7,BATCHID\n";
        Object.keys(initialStock).forEach(k => csv += `INIT,${k},${initialStock[k]},,,,,,,\n`);
        purchases.forEach(p => csv += `PURCHASE,${p.date},${p.item},${p.qty},${p.price},${p.cost},${p.bagQty},,${p.batchId}\n`);
        sales.forEach(s => csv += `SALE,${s.date},${s.orderId},${s.item},${s.qty},${s.amount},${s.coupon},${s.fee},${s.batchId},${s.adjust}\n`);
    }
    const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `å¤‡ä»½_${type}.csv`; link.click();
}

function importData(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split('\n'); if(!confirm("è¦†ç›–æ•°æ®ï¼Ÿ")) return;
        purchases = []; sales = []; initialStock = {};
        lines.forEach((line, index) => {
            if(index === 0 || !line.trim()) return;
            const c = line.split(','); const type = c[0];
            if(type === 'INIT') initialStock[c[1]] = parseInt(c[2]);
            if(type === 'PURCHASE') purchases.push({date:c[1], item:c[2], qty:parseInt(c[3]), price:parseFloat(c[4]), cost:c[5], bagQty:parseInt(c[6]), batchId:c[8]||Date.now()});
            if(type === 'SALE') sales.push({date:c[1], orderId:c[2], item:c[3], qty:parseInt(c[4]), amount:parseFloat(c[5]), coupon:parseFloat(c[6]), fee:parseFloat(c[7]), batchId:c[8]||Date.now(), adjust:parseFloat(c[9]||0)});
        });
        localStorage.setItem('v5_purchases', JSON.stringify(purchases));
        localStorage.setItem('v5_sales', JSON.stringify(sales));
        localStorage.setItem('v5_initialStock', JSON.stringify(initialStock));
        location.reload();
    };
    reader.readAsText(file);
}

window.onload = function() {
    const now = new Date();
    document.getElementById('pDate').valueAsDate = now; document.getElementById('sDate').valueAsDate = now;
    const ySel = document.getElementById('filterYear'), curY = now.getFullYear();
    for(let y = 2024; y <= curY + 5; y++) ySel.options.add(new Option(y + "å¹´", y));
    ySel.value = curY;
    const mSel = document.getElementById('filterMonth');
    mSel.options.add(new Option("å…¨å¹´å®æ—¶", "all"));
    for(let m=0; m<12; m++) mSel.options.add(new Option((m+1)+"æœˆ", m));
    mSel.value = now.getMonth();
    addPurchaseRow(); addSalesRow();
};
</script>
</body>
</html>
