<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>åº“å­˜åŠ©æ‰‹ V6 - è‡ªåŠ¨ç»“è½¬ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --safe-area-inset-bottom: env(safe-area-inset-bottom); }
        body { background-color: #f0f2f5; padding-bottom: calc(80px + var(--safe-area-inset-bottom)); font-size: 14px; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; padding: 12px; }
        .active-tab { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .item-row { background: #fff; padding: 12px; border-left: 5px solid #0d6efd; margin-bottom: 8px; position: relative; border-radius: 8px; }
        .sales-row { border-left-color: #198754; }
        .btn-remove { position: absolute; right: 5px; top: 5px; color: #dc3545; padding: 2px 8px; font-size: 16px; border:none; background:none; }
        .nav-fixed-bottom { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #eee; display: flex; padding: 10px 0 calc(10px + var(--safe-area-inset-bottom)); z-index: 1001; }
        .nav-item { text-align: center; color: #888; text-decoration: none; flex: 1; font-size: 11px; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .history-card { border-radius: 10px; padding: 12px; margin-bottom: 10px; background: #fff; border-left: 4px solid #ddd; }
        .table-responsive { border-radius: 10px; overflow: hidden; }
        th { font-weight: 600; color: #666; background-color: #f8f9fa !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand">åº“å­˜ V6</span>
        <div class="navbar-nav ms-auto">
            <div class="dropdown">
                <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">å¯¼å‡º</button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportType('purchase')">å¯¼å‡ºé‡‡è´­æ¸…å•</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportType('sales')">å¯¼å‡ºé”€å”®æ¸…å•</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="exportType('all')">å¯¼å‡ºå…¨é‡å¤‡ä»½(ç”¨äºå¯¼å…¥)</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-warning btn-sm ms-2" onclick="document.getElementById('importFile').click()">å¯¼å…¥</button>
            <input type="file" id="importFile" accept=".csv" onchange="importData(this)" style="display:none">
        </div>
    </div>
</nav>

<!-- 1. é‡‡è´­å½•å…¥ -->
<div id="purchase" class="tab-content active-tab">
    <div class="card p-3">
        <label class="form-label fw-bold">é‡‡è´­æ—¥æœŸ</label>
        <input type="date" class="form-control mb-3" id="pDate">
        <div id="pItemsContainer"></div>
        <button class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addPurchaseRow()">+ æ·»åŠ è´§å“</button>
        <button class="btn btn-primary w-100 py-2" onclick="savePurchase()">ä¿å­˜æ•´ç¬”é‡‡è´­</button>
    </div>
</div>

<!-- 2. é”€å”®å½•å…¥ -->
<div id="sales" class="tab-content">
    <div class="card p-3">
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="form-label fw-bold">æ—¥æœŸ</label><input type="date" class="form-control" id="sDate"></div>
            <div class="col-6"><label class="form-label fw-bold">è®¢å• ID</label><input type="text" class="form-control" id="sOrderId" placeholder="é€‰å¡«"></div>
        </div>
        <div id="sItemsContainer"></div>
        <button class="btn btn-outline-success btn-sm w-100 mb-3" onclick="addSalesRow()">+ æ·»åŠ è´§å“</button>
        <div class="row g-2 mb-3 pt-2 border-top">
            <div class="col-6"><label class="form-label">æ€»ä¼˜æƒ </label><input type="number" step="0.01" class="form-control" id="sTotalCoupon" value="0"></div>
            <div class="col-6"><label class="form-label">æ‰‹ç»­è´¹</label><input type="number" step="0.01" class="form-control" id="sTotalFee" value="0"></div>
        </div>
        <button class="btn btn-success w-100 py-2" onclick="saveSales()">ç¡®è®¤ç»“å•</button>
    </div>
</div>

<!-- 3. å†å²è®°å½• -->
<div id="history" class="tab-content">
    <div class="btn-group w-100 mb-3 shadow-sm">
        <input type="radio" class="btn-check" name="histType" id="histP" checked onchange="renderHistory()">
        <label class="btn btn-outline-primary" for="histP">é‡‡è´­è®°å½•</label>
        <input type="radio" class="btn-check" name="histType" id="histS" onchange="renderHistory()">
        <label class="btn btn-outline-success" for="histS">é”€å”®å†å²</label>
    </div>
    <div id="historyList"></div>
</div>

<!-- 4. å®æ—¶åº“å­˜ -->
<div id="inventory" class="tab-content">
    <div class="row g-2 mb-3">
        <div class="col-6"><select class="form-select" id="filterYear" onchange="renderInventory()"></select></div>
        <div class="col-6"><select class="form-select" id="filterMonth" onchange="renderInventory()"></select></div>
    </div>
    <div class="table-responsive bg-white shadow-sm">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>åç§°</th>
                    <th class="text-center">ä¸ŠæœŸç»“ä½™</th>
                    <th class="text-center">æœ¬æœŸè¿›</th>
                    <th class="text-center">æœ¬æœŸé”€</th>
                    <th class="text-center">æœŸæœ«åº“å­˜</th>
                </tr>
            </thead>
            <tbody id="inventoryTable"></tbody>
        </table>
    </div>
    <div class="mt-3 small text-muted">
        * <b>ä¸ŠæœŸç»“ä½™</b> = åŸå§‹åˆå§‹åº“å­˜ + è¯¥æ—¥æœŸä¹‹å‰çš„æ‰€æœ‰è¿›è´§ - é”€è´§ã€‚<br>
        * ç‚¹å‡»<b>æœŸæœ«åº“å­˜</b>å¯è®¾ç½®è¯¥äº§å“çš„â€œåŸå§‹åˆå§‹åº“å­˜â€ã€‚
    </div>
</div>

<div class="nav-fixed-bottom">
    <a href="javascript:void(0)" class="nav-item active" onclick="showTab('purchase', this)"><span class="nav-icon">ğŸ“¦</span>è¿›è´§</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('sales', this)"><span class="nav-icon">ğŸ’°</span>å‡ºè´§</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('history', this)"><span class="nav-icon">ğŸ“œ</span>è®°å½•</a>
    <a href="javascript:void(0)" class="nav-item" onclick="showTab('inventory', this)"><span class="nav-icon">ğŸ“Š</span>åº“å­˜</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const products = ["Keychain RM1", "Keychain RM2", "Keychain RM3", "Plush RM1", "Plush RM2", "Plush RM3", "Plush RM5", "Plush RM10", "Plush RM15", "Plush RM20", "Figurine & Toy RM3", "Figurine & Toy RM6", "Figurine & Toy RM10", "Figurine & Toy RM15", "Stationary RM0.6", "Stationary RM1", "Stationary RM2", "Stationary RM3", "Handkechief RM1", "Handkechief RM2", "Handkechief RM3", "Bag RM1", "Bag RM2", "Bag RM3", "Bag RM6", "Others RM3", "Others RM6"];

let purchases = JSON.parse(localStorage.getItem('v5_purchases')) || [];
let sales = JSON.parse(localStorage.getItem('v5_sales')) || [];
let initialStock = JSON.parse(localStorage.getItem('v5_initialStock')) || {};

function showTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active-tab');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    if(id === 'inventory') renderInventory();
    if(id === 'history') renderHistory();
}

// --- åŠ¨æ€è¡Œå¤„ç† ---
function addPurchaseRow() {
    const id = Date.now() + Math.random();
    document.getElementById('pItemsContainer').insertAdjacentHTML('beforeend', `<div class="item-row card" id="pRow_${id}">
        <button class="btn btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        <select class="form-select form-select-sm mb-2 p-item">${products.map(p => `<option value="${p}">${p}</option>`).join('')}</select>
        <div class="row g-2">
            <div class="col-4"><input type="number" step="0.01" class="form-control form-control-sm p-price" placeholder="ä»·"></div>
            <div class="col-4"><input type="number" class="form-control form-control-sm p-qty" placeholder="é‡"></div>
            <div class="col-4 d-flex align-items-center small"><input type="checkbox" class="p-bag me-1">+0.2</div>
        </div>
    </div>`);
}

function addSalesRow() {
    const id = Date.now() + Math.random();
    document.getElementById('sItemsContainer').insertAdjacentHTML('beforeend', `<div class="item-row sales-row card" id="sRow_${id}">
        <button class="btn btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        <select class="form-select form-select-sm mb-2 s-item">${products.map(p => `<option value="${p}">${p}</option>`).join('')}</select>
        <div class="row g-2">
            <div class="col-6"><input type="number" step="0.01" class="form-control form-control-sm s-price" placeholder="é‡‘é¢"></div>
            <div class="col-6"><input type="number" class="form-control form-control-sm s-qty" placeholder="æ•°é‡"></div>
        </div>
    </div>`);
}

function savePurchase() {
    const date = document.getElementById('pDate').value, batchId = Date.now(), rows = document.querySelectorAll('#pItemsContainer .item-row');
    if(!date || rows.length === 0) return alert('è¯·å¡«å†™æ—¥æœŸå’Œå†…å®¹');
    rows.forEach(row => {
        const item = row.querySelector('.p-item').value, price = parseFloat(row.querySelector('.p-price').value) || 0, qty = parseInt(row.querySelector('.p-qty').value) || 0, bag = row.querySelector('.p-bag').checked;
        if(qty > 0) purchases.push({ batchId, date, item, qty, price: bag?price+0.2:price, cost: ((bag?price+0.2:price)*qty).toFixed(2) });
    });
    localStorage.setItem('v5_purchases', JSON.stringify(purchases));
    document.getElementById('pItemsContainer').innerHTML = ''; alert('é‡‡è´­å·²ä¿å­˜');
}

function saveSales() {
    const date = document.getElementById('sDate').value, orderId = document.getElementById('sOrderId').value || 'ID-'+Date.now(), batchId = Date.now(), coupon = parseFloat(document.getElementById('sTotalCoupon').value) || 0, fee = parseFloat(document.getElementById('sTotalFee').value) || 0;
    const rows = document.querySelectorAll('#sItemsContainer .item-row');
    if(!date || rows.length === 0) return alert('è¯·å¡«å†™æ•°æ®');
    rows.forEach(row => {
        const item = row.querySelector('.s-item').value, amount = parseFloat(row.querySelector('.s-price').value) || 0, qty = parseInt(row.querySelector('.s-qty').value) || 0;
        if(qty > 0) sales.push({ batchId, date, orderId, item, qty, amount, coupon, fee });
    });
    localStorage.setItem('v5_sales', JSON.stringify(sales));
    document.getElementById('sItemsContainer').innerHTML = ''; alert('è®¢å•å·²å…¥è´¦');
}

// --- å†å²ä¸ç»“è½¬åº“å­˜é€»è¾‘ ---
function renderHistory() {
    const list = document.getElementById('historyList'), isP = document.getElementById('histP').checked, data = isP ? purchases : sales, groups = {};
    list.innerHTML = '';
    data.forEach(d => { if(!groups[d.batchId]) groups[d.batchId] = []; groups[d.batchId].push(d); });
    Object.keys(groups).sort((a,b) => b-a).forEach(id => {
        const items = groups[id], first = items[0];
        let sub = items.reduce((s, i) => s + parseFloat(isP ? i.cost : i.amount), 0);
        let final = isP ? sub : (sub - first.coupon - first.fee);
        list.innerHTML += `<div class="history-card shadow-sm border-start border-4 ${isP?'border-primary':'border-success'}">
            <div class="history-header"><span class="fw-bold">${first.date}</span><span class="badge ${isP?'bg-primary':'bg-success'}">RM ${final.toFixed(2)}</span></div>
            <div class="history-detail mb-2">
                ${!isP ? `å•å·: ${first.orderId}<br>` : ''}
                ${items.map(i => `Â· ${i.item} x ${i.qty} (RM${isP?i.cost:i.amount})`).join('<br>')}
            </div>
            <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteBatch('${id}', ${isP})">åˆ é™¤è®°å½•</button>
        </div>`;
    });
}

function deleteBatch(id, isP) {
    if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
    if(isP) { purchases = purchases.filter(p => p.batchId != id); localStorage.setItem('v5_purchases', JSON.stringify(purchases)); }
    else { sales = sales.filter(s => s.batchId != id); localStorage.setItem('v5_sales', JSON.stringify(sales)); }
    renderHistory();
}

function renderInventory() {
    const year = parseInt(document.getElementById('filterYear').value);
    const month = document.getElementById('filterMonth').value;
    const tbody = document.getElementById('inventoryTable');
    tbody.innerHTML = '';

    // è®¡ç®—ç­›é€‰å‘¨æœŸçš„å¼€å§‹æ—¥æœŸ
    const filterStartDate = new Date(year, month === 'all' ? 0 : parseInt(month), 1);

    products.forEach(name => {
        // 1. è®¡ç®—ã€ä¸ŠæœŸç»“ä½™ã€‘ï¼šç­›é€‰å‘¨æœŸå¼€å§‹å‰(ä¸å«ä»Šå¤©)çš„æ‰€æœ‰å˜åŠ¨
        const preIn = purchases.filter(p => new Date(p.date) < filterStartDate && p.item === name).reduce((s, p) => s + p.qty, 0);
        const preOut = sales.filter(s => new Date(s.date) < filterStartDate && s.item === name).reduce((s, s1) => s + s1.qty, 0);
        const openingBalance = (initialStock[name] || 0) + preIn - preOut;

        // 2. è®¡ç®—ã€æœ¬æœŸå˜åŠ¨ã€‘ï¼šåœ¨ç­›é€‰å‘¨æœŸå†…çš„å˜åŠ¨
        const currentIn = purchases.filter(p => {
            const d = new Date(p.date);
            return p.item === name && d.getFullYear() === year && (month === 'all' || d.getMonth() == month);
        }).reduce((s, p) => s + p.qty, 0);

        const currentOut = sales.filter(s => {
            const d = new Date(s.date);
            return s.item === name && d.getFullYear() === year && (month === 'all' || d.getMonth() == month);
        }).reduce((s, s1) => s + s1.qty, 0);

        const closingBalance = openingBalance + currentIn - currentOut;

        tbody.innerHTML += `<tr>
            <td style="font-size:11px">${name}</td>
            <td class="text-center text-muted">${openingBalance}</td>
            <td class="text-center text-success">${currentIn}</td>
            <td class="text-center text-danger">${currentOut}</td>
            <td class="text-center fw-bold text-primary" onclick="editInitial('${name}')">${closingBalance}</td>
        </tr>`;
    });
}

function editInitial(name) {
    const val = prompt(`è®¾ç½® ${name} çš„â€œåŸå§‹åˆå§‹åº“å­˜â€\n(å³ä½ åˆšå¼€å§‹ç”¨æœ¬ç³»ç»Ÿæ—¶çš„å®ç‰©æ•°é‡):`, initialStock[name] || 0);
    if(val !== null) { 
        initialStock[name] = parseInt(val) || 0; 
        localStorage.setItem('v5_initialStock', JSON.stringify(initialStock)); 
        renderInventory(); 
    }
}

// --- å¤‡ä»½ ---
function exportType(type) {
    let csv = "\uFEFF";
    let filename = "";
    if (type === 'purchase') {
        filename = `é‡‡è´­æ¸…å•_${new Date().toLocaleDateString()}.csv`;
        csv += "æ—¥æœŸ,è´§å“åç§°,å•ä»·,æ•°é‡,æ€»è®¡\n";
        purchases.forEach(p => csv += `${p.date},${p.item},${p.price},${p.qty},${p.cost}\n`);
    } else if (type === 'sales') {
        filename = `é”€å”®æ¸…å•_${new Date().toLocaleDateString()}.csv`;
        csv += "æ—¥æœŸ,è®¢å•ID,è´§å“,æ•°é‡,åŸä»·,ä¼˜æƒ ,æ‰‹ç»­è´¹,å®æ”¶\n";
        sales.forEach(s => csv += `${s.date},${s.orderId},${s.item},${s.qty},${s.amount},${s.coupon},${s.fee},${(s.amount-s.coupon-s.fee).toFixed(2)}\n`);
    } else {
        filename = `å…¨é‡å¤‡ä»½_V6_${new Date().toISOString().slice(0,10)}.csv`;
        csv += "SECTION,DATA1,DATA2,DATA3,DATA4,DATA5,DATA6,DATA7,BATCHID\n";
        Object.keys(initialStock).forEach(k => csv += `INIT,${k},${initialStock[k]},,,,,,,\n`);
        purchases.forEach(p => csv += `PURCHASE,${p.date},${p.item},${p.qty},${p.price},${p.cost},,,,${p.batchId}\n`);
        sales.forEach(s => csv += `SALE,${s.date},${s.orderId},${s.item},${s.qty},${s.amount},${s.coupon},${s.fee},${s.batchId}\n`);
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; link.click();
}

function importData(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split('\n'); if(!confirm("ç¡®å®šæ¢å¤å¤‡ä»½å¹¶è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Ÿ")) return;
        purchases = []; sales = []; initialStock = {};
        lines.forEach((line, index) => {
            if(index === 0 || !line.trim()) return;
            const c = line.split(','); const type = c[0];
            if(type === 'INIT') initialStock[c[1]] = parseInt(c[2]);
            if(type === 'PURCHASE') purchases.push({date:c[1], item:c[2], qty:parseInt(c[3]), price:parseFloat(c[4]), cost:c[5], batchId:c[9]||Date.now()});
            if(type === 'SALE') sales.push({date:c[1], orderId:c[2], item:c[3], qty:parseInt(c[4]), amount:parseFloat(c[5]), coupon:parseFloat(c[6]), fee:parseFloat(c[7]), batchId:c[8]||Date.now()});
        });
        localStorage.setItem('v5_purchases', JSON.stringify(purchases));
        localStorage.setItem('v5_sales', JSON.stringify(sales));
        localStorage.setItem('v5_initialStock', JSON.stringify(initialStock));
        location.reload();
    };
    reader.readAsText(file);
}

window.onload = function() {
    document.getElementById('pDate').valueAsDate = new Date();
    document.getElementById('sDate').valueAsDate = new Date();
    const ySel = document.getElementById('filterYear'), curY = new Date().getFullYear();
    for(let y=curY; y>=curY-2; y--) ySel.options.add(new Option(y+"å¹´", y));
    const mSel = document.getElementById('filterMonth');
    mSel.options.add(new Option("å…¨å¹´å®æ—¶", "all"));
    for(let m=0; m<12; m++) mSel.options.add(new Option((m+1)+"æœˆ", m));
    addPurchaseRow(); addSalesRow();
};
</script>
</body>
</html>
